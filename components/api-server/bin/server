#!/usr/bin/env node

// Binary for launching the api-server process. 

// Console logging is the weapon of choice here (since we might not have a
// logger) - so disable warnings for the whole file. 
/* eslint-disable no-console */

const Server = require('../src/server');
const Settings = require('../src/settings');

// This bit is useful to trace down promise rejections that aren't caught. 
process.on('unhandledRejection', (reason, promise) => {
  console.warn('Unhandled promise rejection:', promise, 'reason:', reason.stack || reason); 
});
process.on('exit', function () {
  console.info('Server exiting.'); // eslint-disable-line no-console
});

// Load settings
const settings = Settings.load(); 

// Start the server
try {
  const server = new Server(settings); 
  const result = server.start();
  
  // Make sure we catch top-level exceptions.
  result
    .then(() => console.info('Startup sequence complete, Server is running.')) 
    .catch(e => console.error(e)); 
}
catch (err) {
  // Catches synchronous errors that we might have. 
  console.error(err);
  console.trace(err);
  process.exit(1);
}