#!/usr/bin/env node

// Binary for launching the api-server process. 
const cluster = require('cluster')
const os = require('os')

// check if the process is the master process
if(cluster.isMaster){
    // get the number of available cpu cores 
    const nCPUs = os.cpus().length;
    // fork worker processes for each available CPU core
    for(let i = 0; i< nCPUs; i++){
        cluster.fork();
    } 
} else {

const Server = require('../src/server');
const { getApplication } = require('api-server/src/application');

const loadCommonMeta = require('../src/methods/helpers/setCommonMeta').loadSettings;

const { getConfig, getLogger } = require('@pryv/boiler');
const logger = getLogger('serverRoot');

(async () => {
  const config = await getConfig();
  loadCommonMeta({}); // load settings to common meta
  
  // Construct application
  const app = getApplication();
  await app.initiate();

  process.on('exit', () => {
    logger.info('Server stopped.');
  });
  process.on('SIGINT', () => {
    logger.warn('Received SIGINT. Exiting...');
    process.exit(2);
  });

  // Start the server
  const server = new Server(); 
  await server.start();
})()
  .then(() => logger.info('Startup sequence complete, Server is running. mode: [' + process.env.NODE_ENV + ']'))
  .catch(e => {
    if (logger) {
      logger.error(e, e);
    } else {
      console.log(e);
    }
    process.exit(1);
  });
}
