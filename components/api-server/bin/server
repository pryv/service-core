#!/usr/bin/env node

// Binary for launching the api-server process. 

const Server = require('../src/server');
const Application = require('../src/application');
const Settings = require('../src/settings');
const setCommonMeta = require('../src/methods/helpers/setCommonMeta');
let logger, airbrake;
const AirbrakeClient = require('airbrake-js');
const nock = require('nock');

(async () => {
  // TODO ilia : ailleurs ??
  if(process.env.SERVICE_REPORTING_NOCK === '1') {
    console.log('Starting nock service-reporting'); // No logger yet
    await nock('https://reporting.pryv.com')
      .post('/reports')
      .reply(200, (uri, req) => {
        let report = JSON.parse(req);
        report.timestamp = '1580388.366';
        return report;
      });
  }

  // Load settings asynchronously because we have to fetch
  // some values from register via an http-get request.
  const settings = await Settings.load();
  setCommonMeta({}, settings);

  // Construct application
  const app = new Application(settings);
  logger = app.logFactory('api-server');

  // Setup Airbrake if enabled
  const airbrakeSettings = app.settings.get('logs.airbrake').obj();
  if (airbrakeSettings.active) {
    airbrake = new AirbrakeClient({
      projectId: airbrakeSettings.projectId,
      projectKey: airbrakeSettings.key,
    });
  }

  // Catch uncaught Promise rejections
  process.on('unhandledRejection', (reason) => {
    throw reason;
  });

  // Catch uncaught Exceptions
  process.on('uncaughtException', async (error) => {
    if (logger) logger.error(error);
    console.dir(error);
    if (airbrake != null && typeof airbrake.notify === 'function') {
      await airbrake.notify(error);
    }
    process.exit(1);
  });

  process.on('exit', () => {
    logger.info('Server stopped.');
  });
  process.on('SIGINT', () => {
    logger.warn('Received SIGINT. Exiting...');
    process.exit(2);
  });

  // Start the server
  const server = new Server(app); 
  await server.start();
})()
  .then(() => logger.info('Startup sequence complete, Server is running.'))
  .catch(e => {
    if (logger) logger.error(e);
    console.dir(e);
    process.exit(1);
  });
