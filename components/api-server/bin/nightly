#!/usr/bin/env node

// Binary for nightly cron-tasks setup. 

const CronJob = require('cron').CronJob;
const Settings = require('../src/settings');
const bluebird = require('bluebird');
const Application = require('../src/application');

// Load settings
const settings = Settings.load(); 

// Construct application
const app = new Application(settings);
const logger = app.logFactory('nightly-cron');

// Construct storage size object
const storage = require('../../storage');
const storageLayer = app.storageLayer;
const storageSize = new storage.Size(
  storageLayer.users,
  [ storageLayer.accesses,
    storageLayer.events,
    storageLayer.followedSlices,
    storageLayer.streams,
    storageLayer.profile ],
  [ storageLayer.eventFiles ]
);

// This bit is useful to trace down promise rejections that aren't caught. 
process.on('unhandledRejection', (reason, promise) => {
  logger.warn('Unhandled promise rejection:', promise, 'reason:', reason.stack || reason); 
});
process.on('exit', function () {
  logger.info('Service stopped.');
});
process.on('SIGINT', () => {
  logger.warn('Received SIGINT. Exiting...');
  process.exit(2);
});

// Setup cron job
let workerRunning = false;
let cronTimeSetting = settings.get('nightlyScriptCronTime').str();
if (cronTimeSetting === '') {
  logger.info('Nightly script not activated.');
  process.exit(0);
}
const cronJob = new CronJob({
  cronTime: cronTimeSetting,
  onTick: function () {
    if (workerRunning) {
      throw new Error('Previous nigthly script is still running, it is taking too long!');
    }

    logger.info('Starting nightly script (cron job)...');
    workerRunning = true;
    
    bluebird.resolve(runNightlyTasks())
      .then(() => {
        logger.info('Nightly tasks complete.');
      })
      .catch(e => {
        logger.error(e);
      })
      .finally(() => {
        workerRunning = false;
      });
  }
});

logger.info('Cron job setup for nightly script, time pattern: ' + cronJob.cronTime);
cronJob.start();

/**
 * Standalone script to perform nightly tasks (such as updating storage sizes for all users).
 */
async function runNightlyTasks() {
  logger.info('Starting update of storage size');
  
  // Retrieve all existing users
  const users = await bluebird.fromCallback(
    (cb) => storageLayer.users.find(
      {$nor: [{username: /^pool@.*/}, {username: /^temp@.*/}]}, null, cb));

  // Compute storage size used by each user
  for (const user of users) {
    const computeForUser = bluebird.fromCallback(
      (cb) => storageSize.computeForUser(user, cb));
      
    await computeForUser
      .catch((err) => {
        logger.error('Error computing storage size for user "' +
          user.username + '" ' + '(' + user.id + '): ' + err);
      });
  }
  
  logger.info(users.length + ' users updated.');
}

module.exports = runNightlyTasks;
