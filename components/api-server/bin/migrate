#!/usr/bin/env node

// Binary for launching the db migration process. 

const Application = require('../src/application');
const Settings = require('../src/settings');
const bluebird = require('bluebird');

// This bit is useful to trace down promise rejections that aren't caught. 
process.on('unhandledRejection', (reason, promise) => {
  console.warn('Unhandled promise rejection:', promise, 'reason:', reason.stack || reason); 
});
process.on('exit', function () {
  console.info('Process exiting.');
});
process.on('SIGINT', () => {
  console.warn('Received SIGINT. Exiting...');
  process.exit(2);
});

// Load settings
const settings = Settings.load(); 

// Construct application
const application = new Application(settings);

connectAndMigrate(application)
  .then(() => {
    console.info('Storage migration complete.');
    process.exit(0);
  })
  .catch(e => {
    console.error(e);
    process.exit(1);
  });

async function connectAndMigrate(app) {

  console.info('Connecting to storage...');
  await app.storageLayer.waitForConnection();
  
  console.info('Storage connected.');
  
  console.info('Starting migration...');
  return await bluebird.fromCallback(
    (cb) => app.storageLayer.versions.migrateIfNeeded(cb));
}
