#!/usr/bin/env bash
# This file builds all images when packages are installed in the docker image
# (ssh keys has to be given as build arguments). For image build when packages 
# are installed before the build of the docker, please use build/build_workflow.sh script

set -e

# Builds 'service-core' docker image with the version given below. 

# Determine the build_tag and whether we need to release.
build/scripts/build_name

version=$(cat build_tag)
if [ -e release_build ]; then
  echo "This is a release build, it will update 'latest' tags."
fi

# Copy the release version to the project root, so we can later display it to
# clients:
cp ./build_tag ../.api-version

function release {
  local host='pryvsa-docker-release.bintray.io'
  local service_name=$1
  local version=$2
  
  local local_name="$service_name:$version"
  local remote_name="$host/$service_name:$version"
  
  if [ -e ../release_build ]; then
    # Publication to registry: 
    docker tag $local_name $remote_name
    #sudo docker push $remote_name
  fi
}


echo "---------------------------- building core ------------------------------"
docker build --build-arg SSH_PRIVATE_KEY="$(cat ~/.ssh/id_rsa_github)" --build-arg SSH_PUBLIC_KEY="$(cat ~/.ssh/id_rsa_github.pub)" \
    -f build/core/Dockerfile.intermediate -t pryv/core:$version .
release "pryv/core" $version

echo "---------------------------- building preview ---------------------------"
docker build --build-arg SSH_PRIVATE_KEY="$(cat ~/.ssh/id_rsa_github)" --build-arg SSH_PUBLIC_KEY="$(cat ~/.ssh/id_rsa_github.pub)" \
    -f build/preview/Dockerfile.intermediate -t pryv/preview:$version .
release "pryv/preview" $version

echo "---------------------------- building hfs --------------------------------"
docker build --build-arg SSH_PRIVATE_KEY="$(cat ~/.ssh/id_rsa_github)" --build-arg SSH_PUBLIC_KEY="$(cat ~/.ssh/id_rsa_github.pub)" \
    -f build/hfs/Dockerfile.intermediate -t pryv/hfs:$version .
release "pryv/hfs" $version

echo "---------------------------- building cli --------------------------------"
docker build --build-arg SSH_PRIVATE_KEY="$(cat ~/.ssh/id_rsa_github)" --build-arg SSH_PUBLIC_KEY="$(cat ~/.ssh/id_rsa_github.pub)" 
    -f build/cli/Dockerfile.intermediate -t pryv/cli:$version .
release "pryv/cli" $version

echo "---------------------------- building webhooks --------------------------------"
docker build --build-arg SSH_PRIVATE_KEY="$(cat ~/.ssh/id_rsa_github)" --build-arg SSH_PUBLIC_KEY="$(cat ~/.ssh/id_rsa_github.pub)" \
    -f build/webhooks/Dockerfile.intermediate -t pryv/webhooks:$version .
release "pryv/webhooks" $version
