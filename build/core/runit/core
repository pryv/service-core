#!/bin/sh

set -e

cd /app/bin/dist/components/api-server

chown -R app:app /app/log/

# Migrate storage
chpst -u app ./bin/migrate --config /app/conf/core.json

# Sets $num_procs to 2 or the value of $NUM_PROCS, if set.
if [ -z ${NUM_PROCS+x} ]
then
  num_procs=2
else
  num_procs=$NUM_PROCS
fi

export NODE_ENV=production
export NODE_PATH=/app/bin/dist/
exec chpst -u app /app/bin/dist/node_modules/.bin/nf -j production.procfile \
  -p 3000 \
  start api=$num_procs,nats
