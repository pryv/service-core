#!/usr/bin/env bash
# This file builds all images when packages are installed before the build 
# (no auth is needed inside the docker image itself)
set -e

# Builds 'service-core' docker image with the version given below. 

# Determine the build_tag and whether we need to release.
SCRIPT_FOLDER=$(cd $(dirname "$0"); pwd)
$SCRIPT_FOLDER/scripts/build_name

version=$(cat build_tag)
if [ -e release_build ]; then
  echo "This is a release build, it will update 'latest' tags."
fi

# Copy the release version to the project root, so we can later display it to
# clients:
cp ./build_tag ./.api-version

host='pryvsa-docker-release.bintray.io'

# Builds core hfs webhooks preview images
for service in core hfs webhooks preview
do
    echo "---------------------------- building $service --------------------------------"
    docker build --build-arg COMPONENT_NAME=$service  -f $SCRIPT_FOLDER/Dockerfile.intermediate -t pryv/intermediate-$service:latest .
    echo $host/pryv/$service:$version
    docker build -f $SCRIPT_FOLDER/$service/Dockerfile -t $host/pryv/$service:$version .
    docker push $host/pryv/$service:$version
done

echo "---------------------------- building cli --------------------------------"
docker build -f $SCRIPT_FOLDER/cli/Dockerfile -t $host/pryv/cli:$version .
docker push $host/pryv/cli:$version

